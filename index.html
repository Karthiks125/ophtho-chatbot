<script>
    // Flowise Configuration - UPDATED WITH NEW CHATFLOW ID
    const FLOWISE_CHATFLOW_ID = '34b0f5a4-cb2e-4539-ad51-e420cdac38f5';
    const FLOWISE_API_URL = `https://deathstrokeslade20-ophtho-chatbot.hf.space/api/v1/prediction/${FLOWISE_CHATFLOW_ID}`;
    
    // Initialize event listeners when page loads
    document.addEventListener('DOMContentLoaded', function() {
        const input = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        sendButton.addEventListener('click', sendMessage);

        // Hide example questions after first interaction
        const hideExamples = () => {
            const exampleQuestions = document.querySelector('.example-questions');
            if (exampleQuestions) {
                exampleQuestions.classList.add('hidden');
            }
        };
        
        input.addEventListener('focus', hideExamples);
        sendButton.addEventListener('click', hideExamples);
    });
    
    // Send message function
    async function sendMessage() {
        const input = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const message = input.value.trim();
        
        if (!message) return;
        
        // Disable input while processing
        input.disabled = true;
        sendButton.disabled = true;
        
        // Add user message to chat
        addMessage(message, 'user');
        input.value = '';
        
        // Show typing indicator
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message bot';
        typingDiv.innerHTML = `
            <div class="message-avatar">ðŸ¤–</div>
            <div class="typing-indicator active">
                <span></span>
                <span></span>
                <span></span>
            </div>
        `;
        document.getElementById('chatMessages').appendChild(typingDiv);
        scrollToBottom();
        
        try {
            // Call Flowise API
            const response = await fetch(FLOWISE_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    question: message
                })
            });
            
            if (!response.ok) {
                throw new Error(`API Error: ${response.status} - ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // Remove typing indicator
            typingDiv.remove();
            
            // Add bot response
            addMessage(data.text || data.answer || 'No response received', 'bot');
            
        } catch (error) {
            console.error('Error:', error);
            typingDiv.remove();
            addMessage(`Sorry, I encountered an error: ${error.message}. Please try again or contact support.`, 'bot', true);
        } finally {
            // Re-enable input
            input.disabled = false;
            sendButton.disabled = false;
            input.focus();
        }
    }
    
    // Format markdown text to HTML
    function formatMessage(text) {
        // Convert markdown bold (**text**) to HTML
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Convert single asterisk bullets (* item) to proper bullets
        text = text.replace(/^\* (.+)$/gm, '<li>$1</li>');
        
        // Wrap consecutive list items in <ul> tags
        text = text.replace(/(<li>.*<\/li>\n?)+/gs, '<ul>$&</ul>');
        
        // Add line breaks for paragraph separation (double newlines)
        text = text.replace(/\n\n/g, '<br><br>');
        
        // Single newlines become single <br>
        text = text.replace(/\n/g, '<br>');
        
        return text;
    }
    
    // Add message to chat
    function addMessage(text, sender, isError = false) {
        const messagesDiv = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        const avatar = sender === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–';
        const contentClass = isError ? 'message-content error-message' : 'message-content';
        
        messageDiv.innerHTML = `
            <div class="message-avatar">${avatar}</div>
            <div class="${contentClass}">${formatMessage(text)}</div>
        `;
        
        messagesDiv.appendChild(messageDiv);
        scrollToBottom();
    }
    
    // Example question handler
    function askExample(question) {
        document.getElementById('userInput').value = question;
        // Hide example questions
        const exampleQuestions = document.querySelector('.example-questions');
        if (exampleQuestions) exampleQuestions.classList.add('hidden');
        sendMessage();
    }
    
    // Scroll to bottom of chat
    function scrollToBottom() {
        const messagesDiv = document.getElementById('chatMessages');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>

